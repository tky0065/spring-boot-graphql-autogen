name: ğŸ” Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # Validation rapide pour feedback immÃ©diat
  quick-validation:
    name: âš¡ Validation rapide
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ” Validation compilation
        run: mvn clean compile -q

      - name: ğŸ§ª Tests rapides
        run: mvn test -Dtest=**/*Test -DfailIfNoTests=false

      - name: ğŸ“ Commentaire rÃ©sultat rapide
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ job.status }}';
            const body = status === 'success' 
              ? 'âœ… **Validation rapide rÃ©ussie** - Tests de base OK'
              : 'âŒ **Validation rapide Ã©chouÃ©e** - VÃ©rifiez la compilation et les tests de base';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Validation complÃ¨te
  full-validation:
    name: ğŸ” Validation complÃ¨te
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: quick-validation
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ§ª Tests complets
        run: mvn clean verify -Pci

      - name: ğŸ“Š Analyse de couverture
        run: |
          mvn jacoco:report
          COVERAGE=$(mvn jacoco:check -q | grep -o '[0-9]*\.[0-9]*%' | tail -1 || echo "N/A")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: ğŸ” Checkstyle
        run: mvn checkstyle:check || echo "Checkstyle warnings found"

      - name: ğŸ“ PMD Analysis
        run: mvn pmd:check || echo "PMD warnings found"

      - name: ğŸ”’ Security scan
        run: mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=8

      - name: ğŸ“Š GÃ©nÃ©ration du rapport
        run: |
          cat > pr-report.md << EOF
          ## ğŸ“Š Rapport de validation PR
          
          ### âœ… Tests
          - **Tests unitaires** : $(mvn surefire-report:report -q && echo "âœ… PassÃ©s" || echo "âŒ Ã‰chouÃ©s")
          - **Tests d'intÃ©gration** : $(mvn failsafe:verify -q && echo "âœ… PassÃ©s" || echo "âŒ Ã‰chouÃ©s")
          - **Couverture de code** : ${COVERAGE}
          
          ### ğŸ” QualitÃ© du code
          - **Compilation** : âœ… RÃ©ussie
          - **Checkstyle** : $(mvn checkstyle:check -q && echo "âœ… OK" || echo "âš ï¸ Warnings")
          - **PMD** : $(mvn pmd:check -q && echo "âœ… OK" || echo "âš ï¸ Warnings")
          
          ### ğŸ”’ SÃ©curitÃ©
          - **Audit dÃ©pendances** : $(mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=8 -q && echo "âœ… OK" || echo "âš ï¸ VulnÃ©rabilitÃ©s trouvÃ©es")
          
          ### ğŸ“¦ Build
          - **Packaging** : $(mvn package -DskipTests=true -q && echo "âœ… RÃ©ussi" || echo "âŒ Ã‰chouÃ©")
          
          ---
          *Rapport gÃ©nÃ©rÃ© automatiquement le $(date)*
          EOF

      - name: ğŸ“ Commentaire dÃ©taillÃ©
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('pr-report.md', 'utf8');
            
            // Chercher un commentaire existant
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Rapport de validation PR')
            );
            
            if (botComment) {
              // Mettre Ã  jour le commentaire existant
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } else {
              // CrÃ©er un nouveau commentaire
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

  # Validation des changements spÃ©cifiques
  change-validation:
    name: ğŸ” Validation des changements
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ğŸ“¥ Checkout base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: ğŸ” Analyse des fichiers modifiÃ©s
        id: changes
        run: |
          # Fichiers modifiÃ©s
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Types de changements
          HAS_JAVA=$(echo "$CHANGED_FILES" | grep -q '\.java$' && echo "true" || echo "false")
          HAS_POM=$(echo "$CHANGED_FILES" | grep -q 'pom\.xml$' && echo "true" || echo "false")
          HAS_DOCS=$(echo "$CHANGED_FILES" | grep -q '\.md$' && echo "true" || echo "false")
          HAS_TESTS=$(echo "$CHANGED_FILES" | grep -q 'src/test/' && echo "true" || echo "false")
          
          echo "has_java=$HAS_JAVA" >> $GITHUB_OUTPUT
          echo "has_pom=$HAS_POM" >> $GITHUB_OUTPUT
          echo "has_docs=$HAS_DOCS" >> $GITHUB_OUTPUT
          echo "has_tests=$HAS_TESTS" >> $GITHUB_OUTPUT

      - name: â˜• Setup Java (si nÃ©cessaire)
        if: steps.changes.outputs.has_java == 'true' || steps.changes.outputs.has_pom == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ§ª Tests ciblÃ©s pour les changements Java
        if: steps.changes.outputs.has_java == 'true'
        run: |
          # ExÃ©cuter seulement les tests des modules modifiÃ©s
          CHANGED_MODULES=$(echo "${{ steps.changes.outputs.changed_files }}" | grep '\.java$' | cut -d'/' -f1 | sort -u)
          for module in $CHANGED_MODULES; do
            if [[ -f "$module/pom.xml" ]]; then
              echo "Testing module: $module"
              mvn test -pl "$module" -am
            fi
          done

      - name: ğŸ“ Validation des POMs
        if: steps.changes.outputs.has_pom == 'true'
        run: |
          # VÃ©rifier que les POMs sont valides
          mvn validate
          echo "âœ… POMs valides"

      - name: ğŸ“š Validation de la documentation
        if: steps.changes.outputs.has_docs == 'true'
        run: |
          # VÃ©rifier les liens dans la documentation
          echo "ğŸ” VÃ©rification de la documentation..."
          
          # VÃ©rifier que les liens internes fonctionnent
          CHANGED_DOCS=$(echo "${{ steps.changes.outputs.changed_files }}" | grep '\.md$')
          for doc in $CHANGED_DOCS; do
            if [[ -f "$doc" ]]; then
              echo "VÃ©rification de $doc"
              # Ici on pourrait ajouter un linter Markdown
            fi
          done
          echo "âœ… Documentation vÃ©rifiÃ©e"

      - name: ğŸ§ª Validation des tests
        if: steps.changes.outputs.has_tests == 'true'
        run: |
          echo "ğŸ§ª Nouveaux tests dÃ©tectÃ©s, validation en cours..."
          
          # VÃ©rifier que les nouveaux tests passent
          NEW_TESTS=$(echo "${{ steps.changes.outputs.changed_files }}" | grep 'src/test/.*\.java$')
          for test_file in $NEW_TESTS; do
            if [[ -f "$test_file" ]]; then
              # Extraire le nom de la classe de test
              TEST_CLASS=$(basename "$test_file" .java)
              MODULE=$(echo "$test_file" | cut -d'/' -f1)
              
              echo "ExÃ©cution du test: $TEST_CLASS dans $MODULE"
              mvn test -pl "$MODULE" -Dtest="$TEST_CLASS"
            fi
          done

  # VÃ©rification des conventions
  conventions:
    name: ğŸ“ VÃ©rification des conventions
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ“ VÃ©rification du titre de la PR
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # VÃ©rifier le format du titre (emoji + description)
          if [[ ! "$PR_TITLE" =~ ^[[:space:]]*[[:alnum:][:punct:]]+[[:space:]]+.+ ]]; then
            echo "âš ï¸ Le titre de la PR devrait commencer par un emoji"
          fi
          
          # VÃ©rifier la longueur
          if [[ ${#PR_TITLE} -lt 10 ]]; then
            echo "âŒ Le titre de la PR est trop court (minimum 10 caractÃ¨res)"
            exit 1
          fi
          
          if [[ ${#PR_TITLE} -gt 72 ]]; then
            echo "âš ï¸ Le titre de la PR est long (recommandÃ©: max 72 caractÃ¨res)"
          fi
          
          echo "âœ… Titre de la PR validÃ©"

      - name: ğŸ“ VÃ©rification de la description
        run: |
          DESCRIPTION="${{ github.event.pull_request.body }}"
          
          if [[ -z "$DESCRIPTION" || "$DESCRIPTION" == "null" ]]; then
            echo "âŒ La PR doit avoir une description"
            exit 1
          fi
          
          if [[ ${#DESCRIPTION} -lt 20 ]]; then
            echo "âŒ La description de la PR est trop courte (minimum 20 caractÃ¨res)"
            exit 1
          fi
          
          echo "âœ… Description de la PR validÃ©e"

      - name: ğŸ·ï¸ VÃ©rification des labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            
            if (labels.length === 0) {
              core.warning('Cette PR n\'a pas de labels. ConsidÃ©rez ajouter des labels appropriÃ©s.');
            }
            
            const validLabels = ['feature', 'bugfix', 'documentation', 'refactor', 'test', 'breaking-change'];
            const hasValidLabel = labels.some(label => validLabels.includes(label));
            
            if (!hasValidLabel) {
              core.warning('ConsidÃ©rez ajouter un label de type: ' + validLabels.join(', '));
            }

  # RÃ©sumÃ© final
  pr-summary:
    name: ğŸ“‹ RÃ©sumÃ© de validation
    runs-on: ubuntu-latest
    needs: [quick-validation, full-validation, change-validation, conventions]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“Š GÃ©nÃ©ration du rÃ©sumÃ© final
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'Validation rapide': '${{ needs.quick-validation.result }}',
              'Validation complÃ¨te': '${{ needs.full-validation.result }}',
              'Validation des changements': '${{ needs.change-validation.result }}',
              'Conventions': '${{ needs.conventions.result }}'
            };
            
            let summary = '## ğŸ“‹ RÃ©sumÃ© de validation de la PR\n\n';
            let allSuccess = true;
            
            for (const [job, result] of Object.entries(jobs)) {
              const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
              summary += `- ${emoji} **${job}**: ${result}\n`;
              if (result !== 'success') allSuccess = false;
            }
            
            summary += '\n';
            
            if (allSuccess) {
              summary += 'ğŸ‰ **Toutes les validations sont rÃ©ussies!** Cette PR est prÃªte pour la review.\n';
            } else {
              summary += 'âš ï¸ **Certaines validations ont Ã©chouÃ©.** Veuillez corriger les problÃ¨mes avant de demander une review.\n';
            }
            
            summary += '\n---\n*Validation automatique terminÃ©e*';
            
            // Poster le rÃ©sumÃ© comme commentaire
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
